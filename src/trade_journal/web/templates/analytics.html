{% extends "base.html" %}

{% block content %}
<section class="analytics-hero">
  <div>
    <h1>Analytics</h1>
    <p>Deep dive into performance, execution quality, and edge attribution.</p>
  </div>
  <div class="analytics-score">
    <div class="analytics-score-label">Performance Score</div>
    <div class="analytics-score-value">
      {{ performance_score.score | round(1) if performance_score and performance_score.score is not none else 'n/a' }}
    </div>
    <div class="analytics-score-meta">
      {{ summary.total_trades or 0 }} trades - Win rate {{ summary.win_rate | percent }}
    </div>
  </div>
</section>

<form class="filter-bar" method="get" action="/analytics">
  <input type="hidden" name="venue" value="{{ venue }}" />
  <input type="hidden" name="tab" value="{{ tab }}" />
  <input type="hidden" name="symbol" id="symbolValue" value="{{ filters.symbols | join(',') }}" />
  {% set session_options = [
    {'key': 'asia', 'label': 'Asia', 'type': 'base'},
    {'key': 'london', 'label': 'London', 'type': 'base'},
    {'key': 'ny', 'label': 'NY', 'type': 'base'},
    {'key': 'tokyo_london_overlap', 'label': 'Asia-London', 'type': 'overlap'},
    {'key': 'london_ny_overlap', 'label': 'London-NY', 'type': 'overlap'},
  ] %}
  {% set exit_sessions = filters.exit_session if filters.exit_session != 'all' else [] %}
  {% set exit_windows = filters.exit_window if filters.exit_window != 'all' else [] %}
  <label>
    <span>From</span>
    <input type="date" name="from" value="{{ filters['from'] or '' }}" />
  </label>
  <label>
    <span>To</span>
    <input type="date" name="to" value="{{ filters['to'] or '' }}" />
  </label>
  <div class="symbol-picker">
    <span>Symbols</span>
    <div class="symbol-wheel" id="symbolWheel">
      <div class="symbol-wheel-current month-wheel-current" id="symbolWheelCurrent">Symbols</div>
      <div class="symbol-wheel-list month-wheel-list" id="symbolWheelList" aria-hidden="true">
        {% for symbol in symbols %}
        <div class="symbol-wheel-item month-wheel-item {% if symbol in filters.symbols %}active{% endif %}" data-symbol="{{ symbol }}">
          {{ symbol | replace('-USDT', '') }}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <label>
    <span>Side</span>
    <select name="side">
      <option value="all" {% if filters.side == 'all' %}selected{% endif %}>All</option>
      <option value="long" {% if filters.side == 'long' %}selected{% endif %}>Long</option>
      <option value="short" {% if filters.side == 'short' %}selected{% endif %}>Short</option>
    </select>
  </label>
  <div class="symbol-picker">
    <span>Session</span>
    <input type="hidden" name="exit_session" id="sessionValue"
      value="{% if exit_sessions %}{{ exit_sessions | join(',') }}{% endif %}" />
    <input type="hidden" name="exit_window" id="sessionWindowValue"
      value="{% if exit_windows %}{{ exit_windows | join(',') }}{% endif %}" />
    <div class="symbol-wheel" id="sessionWheel">
      <div class="symbol-wheel-current month-wheel-current" id="sessionWheelCurrent">Session</div>
      <div class="symbol-wheel-list month-wheel-list" id="sessionWheelList" aria-hidden="true">
        {% for option in session_options %}
        <div class="symbol-wheel-item month-wheel-item
          {% if option.type == 'base' and option.key in exit_sessions %}active{% endif %}
          {% if option.type == 'overlap' and option.key in exit_windows %}active{% endif %}
        "
          data-session="{{ option.key }}"
          data-kind="{{ option.type }}">
          {{ option.label }}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <label>
    <span>Outcome</span>
    <select name="outcome">
      <option value="all" {% if filters.outcome == 'all' %}selected{% endif %}>All</option>
      <option value="win" {% if filters.outcome == 'win' %}selected{% endif %}>Wins</option>
      <option value="loss" {% if filters.outcome == 'loss' %}selected{% endif %}>Losses</option>
      <option value="breakeven" {% if filters.outcome == 'breakeven' %}selected{% endif %}>Breakeven</option>
    </select>
  </label>
  <label>
    <span>Strategy</span>
    <select name="strategy">
      <option value="all" {% if filters.strategy == 'all' %}selected{% endif %}>All</option>
      {% for strategy in strategies %}
      <option value="{{ strategy }}" {% if filters.strategy == strategy %}selected{% endif %}>
        {{ strategy }}
      </option>
      {% endfor %}
    </select>
  </label>
  <label>
    <span>Account</span>
    <select name="account">
      <option value="all" {% if filters.account == 'all' %}selected{% endif %}>All</option>
      {% for account in accounts %}
      <option value="{{ account.account_key }}" {% if filters.account == account.account_key %}selected{% endif %}>
        {{ account.label or account.account_key }}
      </option>
      {% endfor %}
    </select>
  </label>
  <label>
    <span>Normalization</span>
    <select name="normalization">
      <option value="usd" {% if normalization.mode == 'usd' %}selected{% endif %}>USD</option>
      <option value="percent"
        {% if normalization.mode == 'percent' %}selected{% endif %}
        {% if not normalization.available.percent %}disabled{% endif %}
      >
        %
      </option>
      <option value="r"
        {% if normalization.mode == 'r' %}selected{% endif %}
        {% if not normalization.available.r %}disabled{% endif %}
      >
        R
      </option>
    </select>
  </label>
  <div class="filter-actions">
    <button class="filter-apply" type="submit">Apply</button>
    <button class="filter-clear" type="button" id="filterClear">Clear</button>
  </div>
</form>

<nav class="analytics-tabs">
  {% set base = query_base %}
  <a class="{% if tab == 'overview' %}active{% endif %}" href="/analytics?venue={{ venue }}&tab=overview{% if base %}&{{ base }}{% endif %}">Overview</a>
  <a class="{% if tab == 'diagnostics' %}active{% endif %}" href="/analytics?venue={{ venue }}&tab=diagnostics{% if base %}&{{ base }}{% endif %}">Diagnostics</a>
  <a class="{% if tab == 'edge' %}active{% endif %}" href="/analytics?venue={{ venue }}&tab=edge{% if base %}&{{ base }}{% endif %}">Edge</a>
  <a class="{% if tab == 'time' %}active{% endif %}" href="/analytics?venue={{ venue }}&tab=time{% if base %}&{{ base }}{% endif %}">Time</a>
  <a class="{% if tab == 'trades' %}active{% endif %}" href="/analytics?venue={{ venue }}&tab=trades{% if base %}&{{ base }}{% endif %}">Trades</a>
  <div class="analytics-tabs-note">Phase 1 · USD only</div>
</nav>

{% if tab == 'overview' %}
<div class="comparison-bar">
  <div>
    <div class="comparison-label">Compare to</div>
  </div>
  <select id="comparisonSelect">
    <option value="all_trades">All Trades</option>
    <option value="previous_period">Previous Period</option>
    <option value="benchmark">BTC</option>
  </select>
  <div class="comparison-meta" id="comparisonMeta"></div>
</div>
<section class="metrics-grid">
  <div class="metric-card">
    <div class="metric-label">Net P&amp;L</div>
    <div class="metric-value {{ 'positive' if summary.total_net_pnl and summary.total_net_pnl >= 0 else 'negative' }}">
      {{ summary.total_net_pnl | money }}
    </div>
    <div class="metric-delta" data-kpi="net_pnl" data-format="money"></div>
    <div class="metric-sub">Gross {{ summary.total_gross_pnl | money }}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Win Rate</div>
    <div class="metric-value">{{ summary.win_rate | percent }}</div>
    <div class="metric-delta" data-kpi="win_rate" data-format="ratio"></div>
    <div class="metric-sub">Wins {{ summary.wins }} / Losses {{ summary.losses }}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Expectancy</div>
    <div class="metric-value">{{ summary.expectancy | money }}</div>
    <div class="metric-delta" data-kpi="expectancy" data-format="money"></div>
    <div class="metric-sub">Payoff {{ summary.payoff_ratio | round(2) if summary.payoff_ratio is not none else 'n/a' }}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Profit Factor</div>
    <div class="metric-value">{{ summary.profit_factor | round(2) if summary.profit_factor is not none else 'n/a' }}</div>
    <div class="metric-delta" data-kpi="profit_factor" data-format="number"></div>
    <div class="metric-sub">Max DD {{ summary.max_drawdown | money }}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Avg Win</div>
    <div class="metric-value">{{ summary.avg_win | money }}</div>
    <div class="metric-delta" data-kpi="avg_win" data-format="money"></div>
    <div class="metric-sub">Avg Loss {{ summary.avg_loss | money }}</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Performance Score</div>
    <div class="metric-value">
      {{ performance_score.score | round(1) if performance_score and performance_score.score is not none else 'n/a' }}
    </div>
    <div class="metric-delta" data-kpi="performance_score" data-format="number"></div>
    <div class="metric-sub">Consistency {{ performance_score.raw.consistency | percent if performance_score else 'n/a' }}</div>
  </div>
</section>

<section class="analytics-grid">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Performance Radar</h2>
        <p>Balanced view of profitability, risk, and consistency.</p>
      </div>
    </div>
    <canvas id="performanceRadar" height="220"></canvas>
  </div>
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Daily Cumulative P&amp;L</h2>
        <p>Net cumulative P&amp;L by day.</p>
      </div>
    </div>
    <canvas id="dailyCumulativeChart" height="220"></canvas>
  </div>
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Net Daily P&amp;L</h2>
        <p>Daily net P&amp;L distribution.</p>
      </div>
    </div>
    <canvas id="dailyBarChart" height="220"></canvas>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>P&amp;L Distribution</h2>
      <p>Spread of trade outcomes in the filtered set.</p>
    </div>
  </div>
  <canvas id="distChart" height="180"></canvas>
</section>

{% elif tab == 'diagnostics' %}
<section class="chart-grid analytics-charts diagnostics-scatter">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Heat</h2>
      </div>
    </div>
    <div class="scatter-body">
      <canvas id="maeMfeChart" height="200"></canvas>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Capture</h2>
      </div>
    </div>
    <div class="scatter-body">
      <canvas id="mfePnlChart" height="200"></canvas>
    </div>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Efficiency Metrics</h2>
    </div>
  </div>
  <div class="stat-grid">
    <div class="stat-card positive">
      <div class="stat-label">MFE</div>
      <div class="stat-value">{{ summary.median_mfe | money }}</div>
      <div class="stat-sub">Average {{ summary.mean_mfe | money }}</div>
    </div>
    <div class="stat-card negative">
      <div class="stat-label">MAE</div>
      <div class="stat-value">{{ summary.median_mae | money }}</div>
      <div class="stat-sub">Average {{ summary.mean_mae | money }}</div>
    </div>
    <div class="stat-card neutral">
      <div class="stat-label">ETD</div>
      <div class="stat-value">{{ summary.median_etd | money }}</div>
      <div class="stat-sub">Average {{ summary.mean_etd | money }}</div>
    </div>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Diagnostics Table</h2>
    </div>
    <div class="panel-count">{{ diagnostics_table | length }} trades</div>
  </div>
  <div class="table-wrap">
    <table class="table" id="diagnosticsTable">
      <thead>
        <tr>
          <th data-sort="symbol">Symbol</th>
          <th data-sort="pnl">P&amp;L</th>
          <th data-sort="mfe">MFE</th>
          <th data-sort="mae">MAE</th>
          <th data-sort="capture">Capture</th>
          <th data-sort="heat">Heat</th>
          <th data-sort="etd">ETD</th>
        </tr>
      </thead>
      <tbody>
        {% if diagnostics_table %}
          {% for row in diagnostics_table %}
          <tr
            id="diag-{{ row.ui_id }}"
            data-trade-id="{{ row.ui_id }}"
            data-symbol="{{ row.symbol }}"
            data-pnl="{{ row.pnl or 0 }}"
            data-mfe="{{ row.mfe or 0 }}"
            data-mae="{{ row.mae or 0 }}"
            data-capture="{{ row.capture_pct or 0 }}"
            data-heat="{{ row.heat_pct or 0 }}"
            data-etd="{{ row.etd or 0 }}"
          >
            <td>{{ row.symbol }}</td>
            <td class="{{ 'positive' if row.pnl >= 0 else 'negative' }}">{{ row.pnl | money }}</td>
            <td>{{ row.mfe | money }}</td>
            <td>{{ row.mae | money }}</td>
            <td class="
              {% if row.capture_pct is not none %}
                {% if row.capture_pct >= 80 %}capture-80
                {% elif row.capture_pct >= 60 %}capture-60
                {% elif row.capture_pct >= 40 %}capture-40
                {% elif row.capture_pct >= 20 %}capture-20
                {% elif row.capture_pct >= 1 %}capture-1
                {% else %}capture-0
                {% endif %}
              {% endif %}
            ">
              {{ row.capture_pct | round(1) if row.capture_pct is not none else 'n/a' }}{% if row.capture_pct is not none %}%{% endif %}
            </td>
            <td class="
              {% if row.heat_pct is not none %}
                {% if row.heat_pct < 20 %}heat-20
                {% elif row.heat_pct < 40 %}heat-40
                {% elif row.heat_pct < 60 %}heat-60
                {% else %}heat-80
                {% endif %}
              {% endif %}
            ">
              {{ row.heat_pct | round(1) if row.heat_pct is not none else 'n/a' }}{% if row.heat_pct is not none %}%{% endif %}
            </td>
            <td>{{ row.etd | money }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="7" class="empty">No diagnostics available for the current filter.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

{% elif tab == 'edge' %}
<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Direction Analysis</h2>
      <p>Long vs short performance.</p>
    </div>
  </div>
  <div class="direction-grid">
    <div class="direction-card">
      <div class="direction-title">Long</div>
      <div class="direction-value {{ 'positive' if direction_stats.long.net_pnl >= 0 else 'negative' }}">
        {{ direction_stats.long.net_pnl | money }}
      </div>
      <div class="direction-metrics">
        <div>Win rate: {{ direction_stats.long.win_rate | percent }}</div>
        <div>Profit factor: {{ direction_stats.long.profit_factor | round(2) if direction_stats.long.profit_factor is not none else 'n/a' }}</div>
        <div>Expectancy: {{ direction_stats.long.expectancy | money }}</div>
      </div>
    </div>
    <div class="direction-card">
      <div class="direction-title">Short</div>
      <div class="direction-value {{ 'positive' if direction_stats.short.net_pnl >= 0 else 'negative' }}">
        {{ direction_stats.short.net_pnl | money }}
      </div>
      <div class="direction-metrics">
        <div>Win rate: {{ direction_stats.short.win_rate | percent }}</div>
        <div>Profit factor: {{ direction_stats.short.profit_factor | round(2) if direction_stats.short.profit_factor is not none else 'n/a' }}</div>
        <div>Expectancy: {{ direction_stats.short.expectancy | money }}</div>
      </div>
    </div>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Symbol Attribution</h2>
      <p>Which markets drive performance.</p>
    </div>
  </div>
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Trades</th>
          <th>Win %</th>
          <th>Profit Factor</th>
          <th>Expectancy</th>
          <th>Net P&amp;L</th>
        </tr>
      </thead>
      <tbody>
        {% if symbol_breakdown %}
          {% for row in symbol_breakdown %}
          <tr>
            <td>{{ row.symbol }}</td>
            <td>{{ row.trades }}</td>
            <td>{{ row.win_rate | percent }}</td>
            <td>{{ row.profit_factor | round(2) if row.profit_factor is not none else 'n/a' }}</td>
            <td>{{ row.avg_net_pnl | money }}</td>
            <td class="{{ 'positive' if row.total_net_pnl >= 0 else 'negative' }}">{{ row.total_net_pnl | money }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="empty">No trades available for attribution.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

{% elif tab == 'time' %}
<section class="chart-grid analytics-charts">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>P&amp;L by Hour</h2>
        <p>Net performance by local exit hour.</p>
      </div>
    </div>
    <canvas id="hourPnlChart" height="180"></canvas>
  </div>
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Win Rate by Hour</h2>
        <p>Execution quality by time.</p>
      </div>
    </div>
    <canvas id="hourWinChart" height="180"></canvas>
  </div>
</section>

<section class="chart-grid analytics-charts">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>P&amp;L by Weekday</h2>
        <p>Performance by day of week.</p>
      </div>
    </div>
    <canvas id="weekdayPnlChart" height="180"></canvas>
  </div>
  <div class="panel">
    <div class="panel-header">
      <div>
        <h2>Trades by Weekday</h2>
        <p>Volume cadence by day.</p>
      </div>
    </div>
    <canvas id="weekdayTradesChart" height="180"></canvas>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Calendar Heatmap</h2>
      <p>Daily net P&amp;L heatmap.</p>
    </div>
  </div>
  <div class="calendar-grid compact">
    <div class="calendar-header">Mon</div>
    <div class="calendar-header">Tue</div>
    <div class="calendar-header">Wed</div>
    <div class="calendar-header">Thu</div>
    <div class="calendar-header">Fri</div>
    <div class="calendar-header">Sat</div>
    <div class="calendar-header">Sun</div>
    {% for week in calendar.weeks %}
      {% for day in week %}
      <div class="calendar-day compact {{ '' if day.in_month else 'out' }}" data-pnl="{{ day.pnl }}">
        <span class="calendar-number">{{ day.day }}</span>
        <span class="calendar-pnl">{{ day.pnl | money }}</span>
      </div>
      {% endfor %}
    {% endfor %}
  </div>
  <div class="legend">
    <span>Low</span>
    <span class="legend-bar">
      <span class="legend-neg"></span>
      <span class="legend-mid"></span>
      <span class="legend-pos"></span>
    </span>
    <span>High</span>
  </div>
</section>

{% elif tab == 'trades' %}
<section class="panel">
  <div class="panel-header">
    <div>
      <h2>Trades</h2>
      <p>Filtered trade list.</p>
    </div>
  </div>
  <div class="table-wrap">
    <table class="table" id="analyticsTradesTable">
      <thead>
        <tr>
          <th data-sort="exit">Exit</th>
          <th data-sort="symbol">Symbol</th>
          <th data-sort="side">Side</th>
          <th data-sort="size">Size</th>
          <th data-sort="nominal">Nominal</th>
          <th data-sort="pnl">Net P&amp;L</th>
          <th data-sort="return">Return</th>
          <th data-sort="hold">Hold</th>
          <th data-sort="r">R</th>
          <th data-sort="mfe">MFE</th>
          <th data-sort="mae">MAE</th>
          <th data-sort="dte">ETD</th>
          <th data-sort="liq">REKT</th>
        </tr>
      </thead>
      <tbody>
        {% if trades %}
          {% for trade in trades %}
          <tr
            data-exit="{{ trade.exit_time | iso }}"
            data-symbol="{{ trade.symbol | replace('-USDT', '') }}"
            data-side="{{ trade.side }}"
            data-size="{{ trade.exit_size }}"
            data-nominal="{{ trade.entry_price * trade.entry_size }}"
            data-pnl="{{ trade.realized_pnl_net }}"
            data-return="{{ trade.return_pct or 0 }}"
            data-hold="{{ trade.duration_seconds or 0 }}"
            data-r="{{ trade.r_multiple or 0 }}"
            data-mfe="{{ trade.mfe or 0 }}"
            data-mae="{{ trade.mae or 0 }}"
            data-dte="{{ trade.etd or 0 }}"
            data-liq="{{ 1 if trade.liquidated else 0 }}"
            data-url="/trades/{{ trade.ui_id }}?venue={{ venue }}"
            class="{{ 'trade-rekt' if trade.liquidated else '' }}"
          >
            <td>{{ trade.exit_time | timestamp }}</td>
            <td>{{ trade.symbol | replace('-USDT', '') }}</td>
            <td><span class="pill {{ trade.side | lower }}">{{ trade.side }}</span></td>
            <td>{{ trade.exit_size | round(4) }}</td>
            <td>{{ (trade.entry_price * trade.entry_size) | money }}</td>
            <td class="{{ 'positive' if trade.realized_pnl_net >= 0 else 'negative' }} pnl-positive">{{ trade.realized_pnl_net | money }}</td>
            <td>{{ trade.return_pct | percent }}</td>
            <td>{{ trade.duration_seconds | duration }}</td>
            <td>{{ trade.r_multiple | round(2) if trade.r_multiple is not none else 'n/a' }}</td>
            <td class="{{ 'positive' if trade.mfe is not none and trade.mfe >= 0 else 'negative' }} mfe-positive">{{ trade.mfe | money }}</td>
            <td>{{ trade.mae | money }}</td>
            <td>{{ trade.etd | money }}</td>
            <td>{{ 'REKT' if trade.liquidated else '—' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="13" class="empty">No trades match the current filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<script>
  const performanceScore = {{ performance_score | default(None, true) | json | safe }};
  const summaryData = {{ summary | default({}, true) | json | safe }};
  const dailySeries = {{ daily_pnl | default({}, true) | json | safe }};
  const distData = {{ pnl_distribution | default({}, true) | json | safe }};
  const diagnostics = {{ diagnostics | default({}, true) | json | safe }};
  const scatterData = {{ scatter | default({}, true) | json | safe }};
  const timePerf = {{ time_performance | default({}, true) | json | safe }};
  const calendarData = {{ calendar | default({}, true) | json | safe }};
  const comparisons = {{ comparisons | default({}, true) | json | safe }};

  const symbolValue = document.getElementById('symbolValue');
  const symbolWheel = document.getElementById('symbolWheel');
  const symbolWheelCurrent = document.getElementById('symbolWheelCurrent');
  const symbolWheelList = document.getElementById('symbolWheelList');
  const symbolItems = Array.from(document.querySelectorAll('#symbolWheelList .symbol-wheel-item'));
  const sessionValue = document.getElementById('sessionValue');
  const sessionWindowValue = document.getElementById('sessionWindowValue');
  const sessionWheel = document.getElementById('sessionWheel');
  const sessionWheelCurrent = document.getElementById('sessionWheelCurrent');
  const sessionWheelList = document.getElementById('sessionWheelList');
  const sessionItems = Array.from(document.querySelectorAll('#sessionWheelList .symbol-wheel-item'));

  const syncWheelPosition = (wheel, current, list) => {
    if (!wheel || !current || !list) return;
    const wheelRect = wheel.getBoundingClientRect();
    const currentRect = current.getBoundingClientRect();
    const left = currentRect.left - wheelRect.left;
    list.style.left = `${left}px`;
    list.style.width = `${currentRect.width}px`;
  };

  const updateSymbolValue = () => {
    if (!symbolValue) return;
    const selected = symbolItems.filter(item => item.classList.contains('active')).map(item => item.dataset.symbol);
    symbolValue.value = selected.join(',');
    if (symbolWheelCurrent) {
      symbolWheelCurrent.textContent = selected.length ? `Symbols (${selected.length})` : 'Symbols (All)';
    }
  };

  const updateSessionValue = () => {
    if (!sessionValue) return;
    const selected = sessionItems.filter(item => item.classList.contains('active'));
    const baseSessions = selected
      .filter(item => item.dataset.kind === 'base')
      .map(item => item.dataset.session);
    const overlapSessions = selected
      .filter(item => item.dataset.kind === 'overlap')
      .map(item => item.dataset.session);
    sessionValue.value = baseSessions.join(',');
    if (sessionWindowValue) {
      sessionWindowValue.value = overlapSessions.join(',');
    }
    if (sessionWheelCurrent) {
      const count = baseSessions.length + overlapSessions.length;
      sessionWheelCurrent.textContent = count ? `Session (${count})` : 'Session (All)';
    }
  };

  const updateSymbolFocus = () => {
    if (!symbolWheelList) return;
    const mid = symbolWheelList.scrollTop + symbolWheelList.clientHeight / 2;
    let closest = symbolItems[0];
    let closestDist = Infinity;
    symbolItems.forEach(item => {
      const itemMid = item.offsetTop + item.clientHeight / 2;
      const dist = Math.abs(itemMid - mid);
      if (dist < closestDist) {
        closest = item;
        closestDist = dist;
      }
    });
    symbolItems.forEach(item => {
      item.classList.remove('focus', 'near', 'far');
    });
    if (closest) {
      closest.classList.add('focus');
      const idx = symbolItems.indexOf(closest);
      symbolItems.forEach((item, index) => {
        if (item === closest) return;
        const distance = Math.abs(index - idx);
        if (distance === 1) item.classList.add('near');
        if (distance >= 2) item.classList.add('far');
      });
    }
  };

  const wrapWheelScroll = (list) => {
    const max = list.scrollHeight - list.clientHeight;
    if (max <= 0) return;
    if (list.scrollTop <= 0) {
      list.scrollTop = max - 1;
    } else if (list.scrollTop >= max) {
      list.scrollTop = 1;
    }
  };

  const openSymbolWheel = () => {
    if (!symbolWheel || !symbolWheelList) return;
    syncWheelPosition(symbolWheel, symbolWheelCurrent, symbolWheelList);
    symbolWheel.classList.add('open');
    symbolWheelList.setAttribute('aria-hidden', 'false');
    updateSymbolFocus();
  };

  const closeSymbolWheel = () => {
    if (!symbolWheel || !symbolWheelList) return;
    symbolWheel.classList.remove('open');
    symbolWheelList.setAttribute('aria-hidden', 'true');
  };

  if (symbolWheelCurrent && symbolWheelList && symbolItems.length) {
    symbolWheelCurrent.addEventListener('click', () => {
      if (symbolWheel.classList.contains('open')) {
        closeSymbolWheel();
      } else {
        openSymbolWheel();
      }
    });

    symbolWheelCurrent.addEventListener('wheel', event => {
      event.preventDefault();
      if (!symbolWheel.classList.contains('open')) {
        openSymbolWheel();
      }
      symbolWheelList.scrollTop += event.deltaY;
      wrapWheelScroll(symbolWheelList);
      updateSymbolFocus();
    });

    symbolWheelList.addEventListener('scroll', () => {
      wrapWheelScroll(symbolWheelList);
      updateSymbolFocus();
    });

    symbolItems.forEach(item => {
      item.addEventListener('click', event => {
        event.stopPropagation();
        item.classList.toggle('active');
        updateSymbolValue();
      });
    });

    document.addEventListener('click', event => {
      if (!symbolWheel.classList.contains('open')) return;
      if (symbolWheel.contains(event.target)) return;
      closeSymbolWheel();
    });

    window.addEventListener('resize', () => {
      if (symbolWheel.classList.contains('open')) {
        syncWheelPosition(symbolWheel, symbolWheelCurrent, symbolWheelList);
      }
    });

    updateSymbolValue();
  }

  const updateSessionFocus = () => {
    if (!sessionWheelList) return;
    const mid = sessionWheelList.scrollTop + sessionWheelList.clientHeight / 2;
    let closest = sessionItems[0];
    let closestDist = Infinity;
    sessionItems.forEach(item => {
      const itemMid = item.offsetTop + item.clientHeight / 2;
      const dist = Math.abs(itemMid - mid);
      if (dist < closestDist) {
        closest = item;
        closestDist = dist;
      }
    });
    sessionItems.forEach(item => {
      item.classList.remove('focus', 'near', 'far');
    });
    if (closest) {
      closest.classList.add('focus');
      const idx = sessionItems.indexOf(closest);
      sessionItems.forEach((item, index) => {
        if (item === closest) return;
        const distance = Math.abs(index - idx);
        if (distance === 1) item.classList.add('near');
        if (distance >= 2) item.classList.add('far');
      });
    }
  };

  const openSessionWheel = () => {
    if (!sessionWheel || !sessionWheelList) return;
    syncWheelPosition(sessionWheel, sessionWheelCurrent, sessionWheelList);
    sessionWheel.classList.add('open');
    sessionWheelList.setAttribute('aria-hidden', 'false');
    updateSessionFocus();
  };

  const closeSessionWheel = () => {
    if (!sessionWheel || !sessionWheelList) return;
    sessionWheel.classList.remove('open');
    sessionWheelList.setAttribute('aria-hidden', 'true');
  };

  if (sessionWheelCurrent && sessionWheelList && sessionItems.length) {
    sessionWheelCurrent.addEventListener('click', () => {
      if (sessionWheel.classList.contains('open')) {
        closeSessionWheel();
      } else {
        openSessionWheel();
      }
    });

    sessionWheelCurrent.addEventListener('wheel', event => {
      event.preventDefault();
      if (!sessionWheel.classList.contains('open')) {
        openSessionWheel();
      }
      sessionWheelList.scrollTop += event.deltaY;
      wrapWheelScroll(sessionWheelList);
      updateSessionFocus();
    });

    sessionWheelList.addEventListener('scroll', () => {
      wrapWheelScroll(sessionWheelList);
      updateSessionFocus();
    });

    sessionItems.forEach(item => {
      item.addEventListener('click', event => {
        event.stopPropagation();
        item.classList.toggle('active');
        updateSessionValue();
      });
    });

    document.addEventListener('click', event => {
      if (!sessionWheel.classList.contains('open')) return;
      if (sessionWheel.contains(event.target)) return;
      closeSessionWheel();
    });

    window.addEventListener('resize', () => {
      if (sessionWheel.classList.contains('open')) {
        syncWheelPosition(sessionWheel, sessionWheelCurrent, sessionWheelList);
      }
    });

    updateSessionValue();
  }

  const clearButton = document.getElementById('filterClear');
  if (clearButton) {
    clearButton.addEventListener('click', () => {
      const tab = '{{ tab }}';
      window.location.href = `/analytics?tab=${tab}`;
    });
  }

  const comparisonSelect = document.getElementById('comparisonSelect');
  const comparisonMeta = document.getElementById('comparisonMeta');
  const updateComparison = () => {
    if (!comparisonSelect) return;
    const mode = comparisonSelect.value;
    let deltas = {};
    if (mode === 'previous_period') {
      deltas = comparisons.previous_period?.delta || {};
      if (comparisonMeta) {
        const range = comparisons.previous_period?.range;
        if (range && range.length === 2) {
          const start = new Date(range[0]);
          const end = new Date(range[1]);
          if (!Number.isNaN(start.getTime()) && !Number.isNaN(end.getTime())) {
            comparisonMeta.textContent = `${start.toISOString().slice(0, 10)} → ${end.toISOString().slice(0, 10)}`;
          } else {
            comparisonMeta.textContent = 'Previous period';
          }
        } else {
          comparisonMeta.textContent = 'Previous period';
        }
      }
    } else if (mode === 'benchmark') {
      if (comparisonMeta) {
        const value = comparisons.benchmark?.return;
        comparisonMeta.textContent = value !== null && value !== undefined
          ? `BTC ${formatRatioPercent(value)}`
          : 'BTC n/a';
      }
    } else {
      deltas = comparisons.all_trades?.delta || {};
      if (comparisonMeta) {
        comparisonMeta.textContent = 'All trades baseline';
      }
    }
    document.querySelectorAll('.metric-delta').forEach(node => {
      const key = node.dataset.kpi;
      const format = node.dataset.format;
      node.classList.remove('positive', 'negative');
      if (mode === 'benchmark') {
        const value = comparisons.benchmark?.return;
        node.textContent = value !== null && value !== undefined
          ? `BTC ${formatRatioPercent(value)}`
          : 'BTC n/a';
        if (typeof value === 'number') {
          node.classList.toggle('positive', value > 0);
          node.classList.toggle('negative', value < 0);
        }
        return;
      }
      const value = deltas ? deltas[key] : null;
      node.textContent = formatDelta(value, format);
      if (typeof value === 'number') {
        node.classList.toggle('positive', value > 0);
        node.classList.toggle('negative', value < 0);
      }
    });
  };

  if (comparisonSelect) {
    comparisonSelect.addEventListener('change', updateComparison);
    updateComparison();
  }

  const palette = {
    pos: '#2fbf71',
    neg: '#e25c4b',
    accent: '#9a6bff',
    ink: '#c9c0b6',
  };

  const formatMoney = (value) => {
    if (value === null || value === undefined || Number.isNaN(value)) return 'n/a';
    const numeric = Number(value);
    const sign = numeric < 0 ? '-' : '';
    const absValue = Math.abs(numeric);
    return `${sign}$${absValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
  };

  const formatPercent = (value) => {
    if (value === null || value === undefined || Number.isNaN(value)) return 'n/a';
    const numeric = Number(value);
    return `${numeric.toFixed(1)}%`;
  };

  const formatRatioPercent = (value) => {
    if (value === null || value === undefined || Number.isNaN(value)) return 'n/a';
    const numeric = Number(value) * 100;
    return `${numeric.toFixed(1)}%`;
  };

  const formatNumber = (value) => {
    if (value === null || value === undefined || Number.isNaN(value)) return 'n/a';
    return Number(value).toFixed(2);
  };

  const formatDelta = (value, format) => {
    if (value === null || value === undefined || Number.isNaN(value)) return 'n/a';
    const numeric = Number(value);
    const sign = numeric > 0 ? '+' : numeric < 0 ? '-' : '';
    const absValue = Math.abs(numeric);
    if (format === 'money') {
      return `${sign}${formatMoney(absValue)}`;
    }
    if (format === 'ratio') {
      return `${sign}${formatRatioPercent(absValue)}`;
    }
    if (format === 'percent') {
      return `${sign}${formatPercent(absValue)}`;
    }
    return `${sign}${formatNumber(absValue)}`;
  };

  const formatMae = (value) => {
    if (value === null || value === undefined || Number.isNaN(value)) return 'n/a';
    const absValue = Math.abs(Number(value));
    return `-$${absValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
  };

  const getOrCreateScatterTooltip = (chart) => {
    const parent = chart.canvas.parentNode;
    let tooltipEl = parent.querySelector('.chart-tooltip');
    if (!tooltipEl) {
      tooltipEl = document.createElement('div');
      tooltipEl.className = 'chart-tooltip';
      tooltipEl.dataset.locked = 'false';
      tooltipEl.dataset.hideTimeout = '';
      tooltipEl.style.pointerEvents = 'none';
      tooltipEl.addEventListener('mouseenter', () => {
        tooltipEl.dataset.locked = 'true';
        if (tooltipEl.dataset.hideTimeout) {
          clearTimeout(Number(tooltipEl.dataset.hideTimeout));
          tooltipEl.dataset.hideTimeout = '';
        }
      });
      tooltipEl.addEventListener('mouseleave', () => {
        tooltipEl.dataset.locked = 'false';
        tooltipEl.style.opacity = '0';
        tooltipEl.style.pointerEvents = 'none';
      });
      parent.appendChild(tooltipEl);
    }
    return tooltipEl;
  };

  const scatterTooltipHandler = (context) => {
    const { chart, tooltip } = context;
    const tooltipEl = getOrCreateScatterTooltip(chart);
    if (tooltip.opacity === 0) {
      if (tooltipEl.dataset.locked === 'true' || tooltipEl.matches(':hover')) return;
      if (!tooltipEl.dataset.hideTimeout) {
        const timeout = window.setTimeout(() => {
          if (tooltipEl.dataset.locked === 'true' || tooltipEl.matches(':hover')) return;
          tooltipEl.style.opacity = '0';
          tooltipEl.style.pointerEvents = 'none';
          tooltipEl.dataset.hideTimeout = '';
        }, 120);
        tooltipEl.dataset.hideTimeout = String(timeout);
      }
      return;
    }
    const raw = tooltip.dataPoints?.[0]?.raw || {};
    if (tooltipEl.dataset.hideTimeout) {
      clearTimeout(Number(tooltipEl.dataset.hideTimeout));
      tooltipEl.dataset.hideTimeout = '';
    }
    const lines = [
      `PnL: ${formatMoney(raw.pnl)}`,
      `MFE: ${formatMoney(raw.mfe)}`,
      `MAE: ${formatMae(raw.mae)}`,
      `Capture: ${formatPercent(raw.capture_pct)}`,
      `Heat: ${formatPercent(raw.heat_pct)}`,
    ];
    const link = raw.trade_id ? `<a href="#diag-${raw.trade_id}" data-diag-link="true">View in table</a>` : '';
    tooltipEl.innerHTML = `
      ${lines.map(line => `<div>${line}</div>`).join('')}
      ${link ? `<div class="tooltip-link">${link}</div>` : ''}
    `;
    tooltipEl.style.opacity = '1';
    tooltipEl.style.pointerEvents = 'auto';
    tooltipEl.style.left = `${tooltip.caretX}px`;
    tooltipEl.style.top = `${tooltip.caretY}px`;
  };

  const guideColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#d97a3a';

  const buildScatterGuides = (config) => ({
    id: 'scatterGuides',
    afterDraw: (chart) => {
      const xScale = chart.scales.x;
      const yScale = chart.scales.y;
      if (!xScale || !yScale) return;
      const drawLine = (x1, y1, x2, y2) => {
        const ctx = chart.ctx;
        ctx.save();
        ctx.strokeStyle = guideColor;
        ctx.globalAlpha = 0.35;
        ctx.lineWidth = 1;
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        ctx.restore();
      };

      if (config.diagonal) {
        const start = Math.max(xScale.min ?? 0, yScale.min ?? 0);
        const end = Math.min(xScale.max ?? 0, yScale.max ?? 0);
        if (start < end) {
          drawLine(
            xScale.getPixelForValue(start),
            yScale.getPixelForValue(start),
            xScale.getPixelForValue(end),
            yScale.getPixelForValue(end)
          );
        }
      }

      if (config.diagonalNegative) {
        const xMin = Number.isFinite(xScale.min) ? xScale.min : 0;
        const xMax = Number.isFinite(xScale.max) ? xScale.max : 0;
        const yMin = Number.isFinite(yScale.min) ? yScale.min : 0;
        const yMax = Number.isFinite(yScale.max) ? yScale.max : 0;
        const rawPoints = [
          { x: xMin, y: -xMin },
          { x: xMax, y: -xMax },
          { x: -yMin, y: yMin },
          { x: -yMax, y: yMax },
        ].filter(point => point.x >= xMin && point.x <= xMax && point.y >= yMin && point.y <= yMax);
        const points = [];
        rawPoints.forEach(point => {
          const key = `${point.x.toFixed(6)}:${point.y.toFixed(6)}`;
          if (!points.some(existing => `${existing.x.toFixed(6)}:${existing.y.toFixed(6)}` === key)) {
            points.push(point);
          }
        });
        if (points.length >= 2) {
          let start = points[0];
          let end = points[1];
          let maxDist = -Infinity;
          for (let i = 0; i < points.length; i++) {
            for (let j = i + 1; j < points.length; j++) {
              const dx = points[i].x - points[j].x;
              const dy = points[i].y - points[j].y;
              const dist = dx * dx + dy * dy;
              if (dist > maxDist) {
                maxDist = dist;
                start = points[i];
                end = points[j];
              }
            }
          }
          drawLine(
            xScale.getPixelForValue(start.x),
            yScale.getPixelForValue(start.y),
            xScale.getPixelForValue(end.x),
            yScale.getPixelForValue(end.y)
          );
        }
      }

      if (config.vertical !== null && config.vertical !== undefined) {
        const value = Number(config.vertical);
        if (!Number.isNaN(value) && value >= (xScale.min ?? value) && value <= (xScale.max ?? value)) {
          drawLine(
            xScale.getPixelForValue(value),
            yScale.getPixelForValue(yScale.min),
            xScale.getPixelForValue(value),
            yScale.getPixelForValue(yScale.max)
          );
        }
      }

      if (config.horizontal !== null && config.horizontal !== undefined) {
        const value = Number(config.horizontal);
        if (!Number.isNaN(value) && value >= (yScale.min ?? value) && value <= (yScale.max ?? value)) {
          drawLine(
            xScale.getPixelForValue(xScale.min),
            yScale.getPixelForValue(value),
            xScale.getPixelForValue(xScale.max),
            yScale.getPixelForValue(value)
          );
        }
      }
    }
  });

  const radarCanvas = document.getElementById('performanceRadar');
  if (radarCanvas && performanceScore) {
    const labels = [
      'Win %',
      'Profit factor',
      'Avg win/loss',
      'Recovery',
      'Max drawdown',
      'Consistency'
    ];
    const values = [
      performanceScore.components.win_rate,
      performanceScore.components.profit_factor,
      performanceScore.components.avg_win_loss,
      performanceScore.components.recovery_factor,
      performanceScore.components.max_drawdown,
      performanceScore.components.consistency
    ].map(value => value ?? 0);
    new Chart(radarCanvas, {
      type: 'radar',
      data: {
        labels,
        datasets: [{
          label: 'Performance',
          data: values,
          fill: true,
          backgroundColor: 'rgba(154, 107, 255, 0.25)',
          borderColor: 'rgba(154, 107, 255, 0.9)',
          pointBackgroundColor: 'rgba(154, 107, 255, 0.9)',
        }]
      },
      options: {
        scales: {
          r: {
            beginAtZero: true,
            max: 100,
            grid: { color: 'rgba(255,255,255,0.08)' },
            angleLines: { color: 'rgba(255,255,255,0.08)' },
            pointLabels: { color: '#b6a99d', font: { size: 12 } },
            ticks: { display: false },
          }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  const cumulativeCanvas = document.getElementById('dailyCumulativeChart');
  if (cumulativeCanvas && dailySeries.series) {
    let cumulative = 0;
    const points = dailySeries.series.map(item => {
      cumulative += item.pnl;
      return { x: item.day, y: cumulative };
    });
    new Chart(cumulativeCanvas, {
      type: 'line',
      data: {
        datasets: [{
          data: points,
          borderColor: palette.pos,
          backgroundColor: 'rgba(47, 191, 113, 0.15)',
          fill: true,
          tension: 0.3,
        }]
      },
      options: {
        scales: {
          x: { type: 'time', time: { unit: 'day' }, ticks: { color: palette.ink } },
          y: { ticks: { color: palette.ink } },
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  const dailyCanvas = document.getElementById('dailyBarChart');
  if (dailyCanvas && dailySeries.series) {
    const labels = dailySeries.series.map(item => item.day);
    const values = dailySeries.series.map(item => item.pnl);
    new Chart(dailyCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: values.map(value => value >= 0 ? palette.pos : palette.neg),
          borderRadius: 6,
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: palette.ink } },
          y: { ticks: { color: palette.ink } },
        }
      }
    });
  }

  const distCanvas = document.getElementById('distChart');
  if (distCanvas && distData.bins) {
    const labels = distData.bins.map(bin => bin.label || `${Number(bin.start).toFixed(2)} to ${Number(bin.end).toFixed(2)}`);
    const values = distData.bins.map(bin => bin.count || 0);
    new Chart(distCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: labels.map(() => '#c98bff'),
          borderRadius: 6,
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: palette.ink } },
          y: { ticks: { color: palette.ink } },
        }
      }
    });
  }

  const maeCtx = document.getElementById('maeMfeChart');
  if (maeCtx) {
    new Chart(maeCtx, {
      type: 'scatter',
      data: {
        datasets: [{
          data: scatterData.mae_mfe,
          backgroundColor: palette.pos,
        }],
      },
      plugins: [buildScatterGuides({ diagonalNegative: true, vertical: summaryData.median_mae })],
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: false,
            external: scatterTooltipHandler,
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'MAE' },
            ticks: { display: true, maxTicksLimit: 5, autoSkip: true, font: { size: 9 }, padding: 2 },
            grid: { color: 'rgba(0,0,0,0.06)' }
          },
          y: {
            title: { display: true, text: 'MFE' },
            ticks: { display: true, maxTicksLimit: 5, autoSkip: true, font: { size: 9 }, padding: 2 },
            grid: { color: 'rgba(0,0,0,0.06)' }
          },
        }
      }
    });
  }

  const mfeCtx = document.getElementById('mfePnlChart');
  if (mfeCtx) {
    new Chart(mfeCtx, {
      type: 'scatter',
      data: {
        datasets: [{
          data: scatterData.mfe_pnl,
          backgroundColor: palette.neg,
        }],
      },
      plugins: [buildScatterGuides({ diagonal: true, horizontal: 0 })],
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: false,
            external: scatterTooltipHandler,
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'MFE' },
            ticks: { display: true, maxTicksLimit: 5, autoSkip: true, font: { size: 9 }, padding: 2 },
            grid: { color: 'rgba(0,0,0,0.06)' }
          },
          y: {
            title: { display: true, text: 'Realized Net P&L' },
            ticks: { display: true, maxTicksLimit: 5, autoSkip: true, font: { size: 9 }, padding: 2 },
            grid: { color: 'rgba(0,0,0,0.06)' }
          },
        }
      }
    });
  }

  const buildHourSeries = () => {
    const hours = Array.from({ length: 24 }, (_, idx) => idx);
    const totals = Array(24).fill(0);
    const winRates = Array(24).fill(null);
    timePerf.hourly.forEach(row => {
      totals[row.bucket] = row.total_pnl;
      winRates[row.bucket] = row.win_rate !== null ? row.win_rate * 100 : null;
    });
    return { hours, totals, winRates };
  };

  const hourData = buildHourSeries();

  const hourPnlCtx = document.getElementById('hourPnlChart');
  if (hourPnlCtx) {
    new Chart(hourPnlCtx, {
      type: 'bar',
      data: {
        labels: hourData.hours.map(value => `${value}:00`),
        datasets: [{
          data: hourData.totals,
          backgroundColor: hourData.totals.map(value => value >= 0 ? palette.pos : palette.neg),
          borderRadius: 6,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: 'rgba(0,0,0,0.06)' } },
        },
        plugins: { legend: { display: false } },
      },
    });
  }

  const hourWinCtx = document.getElementById('hourWinChart');
  if (hourWinCtx) {
    new Chart(hourWinCtx, {
      type: 'line',
      data: {
        labels: hourData.hours.map(value => `${value}:00`),
        datasets: [{
          data: hourData.winRates,
          borderColor: palette.line,
          backgroundColor: palette.fill,
          tension: 0.25,
          spanGaps: true,
          pointRadius: 2,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { grid: { display: false } },
          y: {
            ticks: { callback: value => `${value}%` },
            grid: { color: 'rgba(0,0,0,0.06)' },
            suggestedMin: 0,
            suggestedMax: 100,
          },
        },
        plugins: { legend: { display: false } },
      },
    });
  }

  const weekdayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const weekdayTotals = Array(7).fill(0);
  const weekdayTrades = Array(7).fill(0);
  timePerf.weekday.forEach(row => {
    weekdayTotals[row.bucket] = row.total_pnl;
    weekdayTrades[row.bucket] = row.count;
  });

  const weekdayPnlCtx = document.getElementById('weekdayPnlChart');
  if (weekdayPnlCtx) {
    new Chart(weekdayPnlCtx, {
      type: 'bar',
      data: {
        labels: weekdayLabels,
        datasets: [{
          data: weekdayTotals,
          backgroundColor: weekdayTotals.map(value => value >= 0 ? palette.pos : palette.neg),
          borderRadius: 6,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: 'rgba(0,0,0,0.06)' } },
        },
        plugins: { legend: { display: false } },
      },
    });
  }

  const weekdayTradesCtx = document.getElementById('weekdayTradesChart');
  if (weekdayTradesCtx) {
    new Chart(weekdayTradesCtx, {
      type: 'bar',
      data: {
        labels: weekdayLabels,
        datasets: [{
          data: weekdayTrades,
          backgroundColor: 'rgba(11, 61, 59, 0.45)',
          borderRadius: 6,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: 'rgba(0,0,0,0.06)' } },
        },
        plugins: { legend: { display: false } },
      },
    });
  }

  const calendarTiles = document.querySelectorAll('.calendar-day.compact');
  if (calendarTiles.length) {
    const maxAbs = Math.max(calendarData.max_abs_pnl || 0, 1);
    Array.from(calendarTiles).forEach(tile => {
      const value = Number(tile.dataset.pnl || 0);
      if (!value) return;
      const intensity = Math.min(Math.abs(value) / maxAbs, 1);
      const color = value < 0
        ? `rgba(176, 59, 40, ${0.15 + 0.55 * intensity})`
        : `rgba(26, 118, 90, ${0.15 + 0.55 * intensity})`;
      tile.style.background = color;
    });
  }

  const diagnosticsTable = document.getElementById('diagnosticsTable');
  if (diagnosticsTable) {
    const headers = diagnosticsTable.querySelectorAll('thead th[data-sort]');
    let currentSort = { key: 'pnl', direction: 'desc' };

    const sortRows = (key, direction) => {
      const rows = Array.from(diagnosticsTable.querySelectorAll('tbody tr'));
      const multiplier = direction === 'asc' ? 1 : -1;
      const getValue = row => {
        const value = row.dataset[key] || '';
        if (key === 'symbol') return value.toLowerCase();
        return Number(value) || 0;
      };
      rows.sort((a, b) => {
        const av = getValue(a);
        const bv = getValue(b);
        if (av < bv) return -1 * multiplier;
        if (av > bv) return 1 * multiplier;
        return 0;
      });
      const body = diagnosticsTable.querySelector('tbody');
      rows.forEach(row => body.appendChild(row));
    };

    headers.forEach(header => {
      header.addEventListener('click', () => {
        const key = header.dataset.sort;
        if (!key) return;
        const direction =
          currentSort.key === key && currentSort.direction === 'desc' ? 'asc' : 'desc';
        currentSort = { key, direction };
        sortRows(key, direction);
      });
    });
  }

  const focusDiagnosticsRow = tradeId => {
    if (!tradeId) return;
    const row = document.getElementById(`diag-${tradeId}`);
    if (!row) return;
    row.classList.remove('row-highlight');
    void row.offsetWidth;
    row.classList.add('row-highlight');
    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
  };

  const handleDiagnosticsHash = () => {
    const hash = window.location.hash || '';
    if (!hash.startsWith('#diag-')) return;
    const tradeId = hash.slice(6);
    focusDiagnosticsRow(tradeId);
  };

  document.addEventListener('click', event => {
    const link = event.target.closest('a[data-diag-link]');
    if (!link) return;
    event.preventDefault();
    const href = link.getAttribute('href') || '';
    if (href.startsWith('#diag-')) {
      history.replaceState(null, '', href);
      handleDiagnosticsHash();
    }
  });

  window.addEventListener('hashchange', handleDiagnosticsHash);
  handleDiagnosticsHash();

  const analyticsTable = document.getElementById('analyticsTradesTable');
  if (analyticsTable) {
    const headers = analyticsTable.querySelectorAll('thead th[data-sort]');
    let currentSort = { key: 'exit', direction: 'desc' };

    const sortRows = (key, direction) => {
      const rows = Array.from(analyticsTable.querySelectorAll('tbody tr'));
      const multiplier = direction === 'asc' ? 1 : -1;
      const getValue = row => {
        const value = row.dataset[key] || '';
        if (key === 'exit') return new Date(value).getTime() || 0;
        if (key === 'symbol' || key === 'side' || key === 'strategy' || key === 'account' || key === 'tags' || key === 'entry_session' || key === 'exit_session') {
          return value.toLowerCase();
        }
        if (key === 'liq') return Number(value) || 0;
        return Number(value) || 0;
      };
      rows.sort((a, b) => {
        const av = getValue(a);
        const bv = getValue(b);
        if (av < bv) return -1 * multiplier;
        if (av > bv) return 1 * multiplier;
        return 0;
      });
      const body = analyticsTable.querySelector('tbody');
      rows.forEach(row => body.appendChild(row));
    };

    headers.forEach(header => {
      header.addEventListener('click', () => {
        const key = header.dataset.sort;
        if (!key) return;
        const direction =
          currentSort.key === key && currentSort.direction === 'desc' ? 'asc' : 'desc';
        currentSort = { key, direction };
        sortRows(key, direction);
      });
    });

    analyticsTable.querySelectorAll('tbody tr').forEach(row => {
      row.addEventListener('click', event => {
        const target = event.target;
        if (target instanceof HTMLElement && target.closest('a')) {
          return;
        }
        const url = row.dataset.url;
        if (url) {
          window.location.href = url;
        }
      });
    });
  }
</script>
{% endblock %}
